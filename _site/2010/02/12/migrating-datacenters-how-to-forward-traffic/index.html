<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head profile="http://gmpg.org/xfn/11">
    <title>Migrating datacenters: How to forward traffic &mdash; In Valid Logic</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Endlessly expanding technology" />
    <meta name="author" content="Ken Robertson" />
    <meta name="generator" content="jekyll" />

    <link href="/css/site.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/css/pygments/trac.css" rel="stylesheet" type="text/css" media="screen" />

    <link href="/atom.xml" rel="alternate" title="Ken Robertson's Atom Feed" type="application/atom+xml" />
    <link href="/rss.xml" rel="alternate" title="Ken Robertson's RSS Feed" type="application/rss+xml" />

    <link rel='index' title='In Valid Logic' href='http://invalidlogic.com/' />
  </head>

<body>
  <div id="container" class="group">

    <h1><a href="http://invalidlogic.com">In Valid Logic</a></h1>
    <div id="bubble"><p>Endlessly expanding technology</p></div>

    <div id="content" class="group">
      <h2>Migrating datacenters: How to forward traffic</h2>

<div class="main">
  <p>I have some of my own datacenter space with a couple of servers that I use for a little bit of hosting that I do.  This weekend, I'm finishing a migration and having done this type of thing a couple of times, thought I'd share a few tips.</p>

<p>First of all, one thing that is very nice to do, if you have a presence in both places at the same time, is to configure IP forwarding from your old site to your new site.  While it is a best practice to set the TTL on your DNS records really low (mine are currently 60 seconds), ISPs don't always honor the TTLs and some will be more aggressive with caching.  As a rule, its usually 8-24 hours before you can really count on old caches being expired.</p>

<p>To combat this, forwarding any traffic that might be going to the old addresses to the new ones can be very helpful, and fairly easy to do.</p>

<p>There can be several ways to do this, but can often times end up more complicated.  The pure and simple way to do it is to use an application called <a href="http://www.boutell.com/rinetd/">rinetd</a>, which is basically an "internet redirection server".  You simple edit its configuration file, specify the old IP address and port, and the new IP address and port.  Run it and you're good!</p>

<p>I run ESXi on some of my systems, so I simply created a new virtual machine with a very basic configuration and installed Ubuntu on it.  I gave it a base IP that I wasn't going to be forwarding, installed SSH on it (to remotely manage it), and then went to town setting up what I needed forwarded.  First, I added the IPs to be forwarded as aliases in /etc/network/interfaces:</p>

<div class="highlight"><pre><code class="text">auto eth0:0
iface eth0:0 inet static
     address 192.168.1.111
     netmask 255.255.255.0
</code></pre>
</div>


<p>Now, I need rinetd.  On Ubuntu, it is readily available as a package, so just run <tt>sudo apt-get install rinetd</tt> and you're set.  Edit the /etc/rinetd.conf to list out how you want things forwarded:</p>

<div class="highlight"><pre><code class="text"># old ip         old port    new ip          new port
192.168.1.111    80          172.16.1.222    80
</code></pre>
</div>


<p>Afterwards, all you need to do is restart networking and rinetd.  So run <tt>sudo /etc/init.d/networking restart</tt> and <tt>sudo /etc/init.d/rinetd restart</tt>.</p>

<p>Few things worth noting.  rinetd binds to the address/port you specify, so if you are trying to forward port 80, you can't have something else bound to port 80 on that IP, such as a webserver.  So if you need to forward something that you might have in use, you may have to tweak things.  If you need to forward SSH, it might be best to configure SSH to use another port for a little while.  Second, I'd sometimes just reboot the virtual machine instead of restarting networking.  I'd migrate some stuff one night and have it forward for 24 hours, then next night migrate something else and have it forwarded.  It'd sometimes get a little hairy adding/removing/reconfiguring aliases a lot, so I'd just reboot.</p>

<p>Another plus with rinetd is that a port of it exists for Windows!  A download exists on <a href="http://www.boutell.com/rinetd/">its site</a> and it is also possible to configure it as a Windows service using <a href="http://serviceex.com/">ServiceEx</a>.  I haven't tried it myself, but I did find some pretty <a href="http://blog.ehuna.org/2009/10/an_easier_way_to_access_the_wi.html">detailed instructions</a> about configuring it on Windows.</p>

</div>

<div class="meta group">
  <div class="signature">
    <p>Friday, February 12, 2010</p>
  </div>	
  <div class="tags">
    &nbsp;
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'invalidlogic'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2010/02/08/one-of-these-things-is-not-like-the-other-except-to-sql/" title="Previous post: One of these things is not like the other, except to SQL">One of these things is not like the other, except to SQL</a></div>
  
  
  
    <div class="next"><a class="next" href="/2010/02/19/two-years-with-ruby/" title="Next post: Two years with Ruby">Two years with Ruby</a> &rarr;</div>
  
</div>
    </div>

    <div id="sidebar">
      <h3>About</h3>
      <div class="textwidget">
        This is the personal blog of Ken Robertson.  I'm a developer at <a href="http://involver.com/">Involver</a> working in Ruby/Rails.  In a former life, I worked in .NET for many years and since moved on.<br/>
        <br/>
        Now, I get to make Rails scale, cook all day long with chef, and experiment with building highly concurrent systems.<br/>
        <br/>
        In my spare time, I like to build things.  I like to experiment with different technologies to find how they best fit onto my utility belt.<br/>
        <br/>
        I sometimes blog.  You'll find those things here.<br/>
        <br/>
        I sometimes code.  You'll find those on <a href="http://github.com/krobertson">Github</a>.<br/>
      </div>

      <h3>Search</h3>
      <form method="get" action="http://www.google.com/search">
        <div>
          <label class="screen-reader-text" for="s">Search for:</label>
          <input type="text" id="s" name="q" value="" />
          <input type="hidden" name="q" value="site:invalidlogic.com" />
          <input type="submit" id="searchsubmit" value="Search" />
        </div>
      </form>

      <h3>Recent Posts</h3>
      <ul>
        
          <li><a href="/2011/04/12/serving-static-content-via-post-from-nginx/">Serving Static Content Via POST From Nginx</a></li>
        
          <li><a href="/2011/02/16/our-pain-points-with-ec2/">Our pain points with EC2 and how our moved solved them</a></li>
        
          <li><a href="/2011/02/11/how-we-did-a-datacenter-migration-with-no-downtime/">How we did a datacenter migration with no downtime</a></li>
        
          <li><a href="/2011/02/07/how-a-deprecated-method-can-take-down-a-process/">How a deprecated method can take down a process</a></li>
        
          <li><a href="/2011/01/19/love-your-dependency-management/">Love your dependency management</a></li>
        
    	</ul>
    </div>

  </div>

  <div id="footer">
    <p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a></p>
  </div>
</body>
</html>