<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head profile="http://gmpg.org/xfn/11">
    <title>Tracing Cache Money transactions through New Relic &mdash; In Valid Logic</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Endlessly expanding technology" />
    <meta name="author" content="Ken Robertson" />
    <meta name="generator" content="jekyll" />

    <link href="/css/site.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/css/pygments/trac.css" rel="stylesheet" type="text/css" media="screen" />

    <link href="/atom.xml" rel="alternate" title="Ken Robertson's Atom Feed" type="application/atom+xml" />
    <link href="/rss.xml" rel="alternate" title="Ken Robertson's RSS Feed" type="application/rss+xml" />

    <link rel='index' title='In Valid Logic' href='http://invalidlogic.com/' />
  </head>

<body>
  <div id="container" class="group">

    <h1><a href="http://invalidlogic.com">In Valid Logic</a></h1>
    <div id="bubble"><p>Endlessly expanding technology</p></div>

    <div id="content" class="group">
      <h2>Tracing Cache Money transactions through New Relic</h2>

<div class="main">
  <p>At Involver, we've been starting to make heavy use of <a href="http://newrelic.com/">New Relic</a> to start monitoring performance and track down bottlenecks.  I've been working to add method tracers around components that utilize external APIs or services, and some of the major components we leverage to know how much time is spent in various areas.</p>

<p>We use <a href="http://github.com/nkallen/cache-money">Cache Money</a>, a gem that helps transparently cache models in Memcached.  Out of the box, New Relic supports tracing calls for Memcached, however on traces we'd see a long list of Memcached calls but no information as to which request they were associated with.</p>

<p>For a lot of our additional traces, we've added an rpm_extras.rb file.  To include tracing for Cache Money, just need to define it as follows:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno">1</span> <span class="o">::</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
<span class="lineno">2</span>   <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
<span class="lineno">3</span>     <span class="n">add_method_tracer</span> <span class="ss">:transaction</span><span class="p">,</span> <span class="s1">&#39;Custom/CacheMoney/transaction&#39;</span>
<span class="lineno">4</span>     <span class="n">add_method_tracer</span> <span class="ss">:find_every</span><span class="p">,</span> <span class="s1">&#39;Custom/CacheMoney/find_every&#39;</span>
<span class="lineno">5</span>     <span class="n">add_method_tracer</span> <span class="ss">:find_from_ids</span><span class="p">,</span> <span class="s1">&#39;Custom/CacheMoney/find_from_ids&#39;</span>
<span class="lineno">6</span>   <span class="k">end</span>
<span class="lineno">7</span> <span class="k">end</span>
</code></pre>
</div>


<p>New Relic itself uses add_method_tracer around transaction and find_by_sql, however Cache Money works by alias_method_chaining transaction, find_every, and find_from_ids.</p>

<p>One thing worth noting is that since both New Relic and Cache Money make use of transaction, order of loading could be important.  In our environment.rb, we load our rpm_extras.rb in the after_initialize block.  When RPM is loaded, it wraps the actual ActiveRecord#transaction call, then Cache Money chains it, and our own tracer wraps the chained call.</p>

<p>Initially, I tried putting the tracer around Cache Money's own transaction_with_cache_transaction, however that didn't show up in traces.</p>

</div>

<div class="meta group">
  <div class="signature">
    <p>Tuesday, June 15, 2010</p>
  </div>	
  <div class="tags">
    &nbsp;
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'invalidlogic'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2010/05/24/isms/" title="Previous post: Isms">Isms</a></div>
  
  
  
    <div class="next"><a class="next" href="/2010/06/18/tracing-controller-filters-in-new-relic/" title="Next post: Tracing controller filters in New Relic">Tracing controller filters in New Relic</a> &rarr;</div>
  
</div>
    </div>

    <div id="sidebar">
      <h3>About</h3>
      <div class="textwidget">
        This is the personal blog of Ken Robertson.  I'm a developer at <a href="http://involver.com/">Involver</a> working in Ruby/Rails.  In a former life, I worked in .NET for many years and since moved on.<br/>
        <br/>
        Now, I get to make Rails scale, cook all day long with chef, and experiment with building highly concurrent systems.<br/>
        <br/>
        In my spare time, I like to build things.  I like to experiment with different technologies to find how they best fit onto my utility belt.<br/>
        <br/>
        I sometimes blog.  You'll find those things here.<br/>
        <br/>
        I sometimes code.  You'll find those on <a href="http://github.com/krobertson">Github</a>.<br/>
      </div>

      <h3>Search</h3>
      <form method="get" action="http://www.google.com/search">
        <div>
          <label class="screen-reader-text" for="s">Search for:</label>
          <input type="text" id="s" name="q" value="" />
          <input type="hidden" name="q" value="site:invalidlogic.com" />
          <input type="submit" id="searchsubmit" value="Search" />
        </div>
      </form>

      <h3>Recent Posts</h3>
      <ul>
        
          <li><a href="/2011/04/14/power-through-environments/">Power through environments</a></li>
        
          <li><a href="/2011/04/12/serving-static-content-via-post-from-nginx/">Serving Static Content Via POST From Nginx</a></li>
        
          <li><a href="/2011/02/16/our-pain-points-with-ec2/">Our pain points with EC2 and how our moved solved them</a></li>
        
          <li><a href="/2011/02/11/how-we-did-a-datacenter-migration-with-no-downtime/">How we did a datacenter migration with no downtime</a></li>
        
          <li><a href="/2011/02/07/how-a-deprecated-method-can-take-down-a-process/">How a deprecated method can take down a process</a></li>
        
    	</ul>
    </div>

  </div>

  <div id="footer">
    <p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a></p>
  </div>
</body>
</html>