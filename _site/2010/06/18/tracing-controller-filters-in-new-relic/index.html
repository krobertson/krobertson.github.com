<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head profile="http://gmpg.org/xfn/11">
    <title>Tracing controller filters in New Relic &mdash; In Valid Logic</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Endlessly expanding technology" />
    <meta name="author" content="Ken Robertson" />
    <meta name="generator" content="jekyll" />

    <link href="/css/site.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/css/pygments/trac.css" rel="stylesheet" type="text/css" media="screen" />

    <link href="/atom.xml" rel="alternate" title="Ken Robertson's Atom Feed" type="application/atom+xml" />
    <link href="/rss.xml" rel="alternate" title="Ken Robertson's RSS Feed" type="application/rss+xml" />

    <link rel='index' title='In Valid Logic' href='http://invalidlogic.com/' />
  </head>

<body>
  <div id="container" class="group">

    <h1><a href="http://invalidlogic.com">In Valid Logic</a></h1>
    <div id="bubble"><p>Endlessly expanding technology</p></div>

    <div id="content" class="group">
      <h2>Tracing controller filters in New Relic</h2>

<div class="main">
  <p>Yet another New Relic goodie today.</p>

<p>One thing I was kind of surprised that New Relic didn't already have instrumentation around out of the box was controller filters.  We had noticed some occasional gaps after the main processing of an action, where all the templates would be rendered, but the execution still went on for a few hundred milliseconds (or sometimes more).  Finally, it dawned that it is probably one of the after_filters.</p>

<p>So we aded tracing around filter execution, and lo and behold, we had one that from time to time would misbehave and execute slow.</p>

<p>To instrument the filters, the simplest way seemed to be by tacking on to the 'call' method of each filter type.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="o">::</span><span class="no">ActionController</span><span class="o">::</span><span class="no">Filters</span><span class="o">::</span><span class="no">BeforeFilter</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
<span class="lineno"> 2</span>   <span class="n">add_method_tracer</span> <span class="ss">:call</span><span class="p">,</span> <span class="s1">&#39;Custom/BeforeFilter/#{method.to_s}&#39;</span>
<span class="lineno"> 3</span> <span class="k">end</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="o">::</span><span class="no">ActionController</span><span class="o">::</span><span class="no">Filters</span><span class="o">::</span><span class="no">AfterFilter</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
<span class="lineno"> 6</span>   <span class="n">add_method_tracer</span> <span class="ss">:call</span><span class="p">,</span> <span class="s1">&#39;Custom/AfterFilter/#{method.to_s}&#39;</span>
<span class="lineno"> 7</span> <span class="k">end</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="o">::</span><span class="no">ActionController</span><span class="o">::</span><span class="no">Filters</span><span class="o">::</span><span class="no">AroundFilter</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
<span class="lineno">10</span>   <span class="n">add_method_tracer</span> <span class="ss">:call</span><span class="p">,</span> <span class="s1">&#39;Custom/AroundFilter/#{method.to_s}&#39;</span>
<span class="lineno">11</span> <span class="k">end</span>
</code></pre>
</div>


<p>And one more goodie while I'm looking at my list of New Relic tracers... ActionMailer.  Have seen this time and time again, that sending email synchronously with the HTTP request can drastically slow down performance.  SMTP server can be slow, can be mailing a number of recipients, submission fails, etc.  For us, most email delivery is asynchronous in the background, but one or two are triggered in line.</p>

<p>To trace ActionMailer delivery:</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno">1</span> <span class="o">::</span><span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
<span class="lineno">2</span>   <span class="n">add_method_tracer</span> <span class="ss">:deliver!</span><span class="p">,</span> <span class="s1">&#39;Custom/ActionMailer/deliver!&#39;</span>
<span class="lineno">3</span> <span class="k">end</span>
</code></pre>
</div>


<p>Will maybe sometime look at email processing more, but email templates are often far simpler and their action methods do less loading.</p>

</div>

<div class="meta group">
  <div class="signature">
    <p>Friday, June 18, 2010</p>
  </div>	
  <div class="tags">
    &nbsp;
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'invalidlogic'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2010/06/15/tracing-cache-money-transactions-through-new-relic/" title="Previous post: Tracing Cache Money transactions through New Relic">Tracing Cache Money transactions through New Relic</a></div>
  
  
  
    <div class="next"><a class="next" href="/2010/07/15/using-server-aliases-with-capistrano-output/" title="Next post: Using server aliases with Capistrano output">Using server aliases with Capistrano output</a> &rarr;</div>
  
</div>
    </div>

    <div id="sidebar">
      <h3>About</h3>
      <div class="textwidget">
        This is the personal blog of Ken Robertson.  I'm a developer at <a href="http://involver.com/">Involver</a> working in Ruby/Rails.  In a former life, I worked in .NET for many years and since moved on.<br/>
        <br/>
        Now, I get to make Rails scale, cook all day long with chef, and experiment with building highly concurrent systems.<br/>
        <br/>
        In my spare time, I like to build things.  I like to experiment with different technologies to find how they best fit onto my utility belt.<br/>
        <br/>
        I sometimes blog.  You'll find those things here.<br/>
        <br/>
        I sometimes code.  You'll find those on <a href="http://github.com/krobertson">Github</a>.<br/>
      </div>

      <h3>Search</h3>
      <form method="get" action="http://www.google.com/search">
        <div>
          <label class="screen-reader-text" for="s">Search for:</label>
          <input type="text" id="s" name="q" value="" />
          <input type="hidden" name="q" value="site:invalidlogic.com" />
          <input type="submit" id="searchsubmit" value="Search" />
        </div>
      </form>

      <h3>Recent Posts</h3>
      <ul>
        
          <li><a href="/2011/04/14/power-through-environments/">Power through environments</a></li>
        
          <li><a href="/2011/04/12/serving-static-content-via-post-from-nginx/">Serving Static Content Via POST From Nginx</a></li>
        
          <li><a href="/2011/02/16/our-pain-points-with-ec2/">Our pain points with EC2 and how our moved solved them</a></li>
        
          <li><a href="/2011/02/11/how-we-did-a-datacenter-migration-with-no-downtime/">How we did a datacenter migration with no downtime</a></li>
        
          <li><a href="/2011/02/07/how-a-deprecated-method-can-take-down-a-process/">How a deprecated method can take down a process</a></li>
        
    	</ul>
    </div>

  </div>

  <div id="footer">
    <p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a></p>
  </div>
</body>
</html>