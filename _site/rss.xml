<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:creativeCommons="http://backend.userland.com/creativeCommonsRssModule">
  <channel>
      <title>In Valid Logic</title>
    <link>http://invalidlogic.com</link>
    <language>en</language>
    <webMaster>ken@invalidlogic.com (Ken Robertson)</webMaster>
    <pubDate>2011-04-14T09:54:32-07:00</pubDate>
    <copyright>Copyright 2009</copyright>
    <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    <ttl>60</ttl>
    <description>Endlessly expanding technology</description>
    
    <item>
      <title>Power through environments</title>
      <link>http://invalidlogic.com/2011/04/14/power-through-environments/</link>
      <pubDate>Thu Apr 14 00:00:00 -0700 2011</pubDate>
      <guid>http://invalidlogic.com/archives/2011/04/14/power-through-environments/</guid>
      <description>&lt;p&gt;At Involver, we have a pretty rich deployment environment that I think isn't very common.  It is normal to hear about places having a separate staging environment from the production environment, and sometimes having a staging and test environment.  We actually go a step further and have a total of 8 non-production environments.  They all serve different purposes, but are all heavily used.&lt;/p&gt;

&lt;p&gt;Our environments are broken up like this:&lt;/p&gt;

&lt;ul&gt;&lt;li&gt;Production: duh, live stuff&lt;/li&gt;
&lt;li&gt;Staging: Used for QA, close to production, no experimental stuff, pretty good data set and history in the DB.&lt;/li&gt;
&lt;li&gt;Demo: Used for client-facing stuff that is under development.  Somewhat experimental, but expected to not be breaking or of a major impact.&lt;/li&gt;
&lt;li&gt;Perf: This environment is regularly repurposed and is used for benchmarking, testing infrastructure changes, and other large scale changes (Rails upgrades, DB upgrades, core app perf testing).&lt;/li&gt;
&lt;li&gt;Test1-5: These guys are pretty special.&lt;/li&gt;&lt;/ul&gt;


&lt;p&gt;The test environments are something special and are meant to be highly flexible.  They are used to deploy separate git branches to an environment that has all the different elements of our application fully orchestrated.  They are useful for testing volatile code, experimental code, or for performing QA on features or feature branches before the code gets merged into master.&lt;/p&gt;

&lt;p&gt;The deployment to these environments works by specifying the branch on deploy, and it will create the MySQL/Mongo databases, setup the DB schema, bootstrap the DB with some initial data, and then configure all the configuration files and even config files for other applications that it interacts with.  Each branch on each environment gets its own database.  And between deploys, the data for your branch is fully preserved.&lt;/p&gt;

&lt;p&gt;So say you deploy &quot;dev-fix-booboo&quot; to test3 for the first time.  It sets you up with a fresh dataset and are good to go.  You do your thing, then later on, someone deploys another branch.  They get their own DB, not mucking up the stuff you previously had done, and when you deploy there again, you are right back where you left off.&lt;/p&gt;

&lt;p&gt;Since they are specific to the environment too, we often times assign a long-running feature branch to an environment, so that the data used by QA sticks around more, and smaller test branches can use them here and there.&lt;/p&gt;

&lt;p&gt;The full power of these comes form:&lt;/p&gt;

&lt;ol&gt;&lt;li&gt;Flexibility.  I have a branch I want to deploy, but not much other environments.  Sweet.&lt;/li&gt;
&lt;li&gt;Some element of persistence.  I can use it for a few days, come back, and be right where I left off.  No risk of someone polluting my stuff with bad data.&lt;/li&gt;
&lt;li&gt;QA can actually deploy to them and pick which is available.  For non-feature branch testing, this gives them great flexibility.&lt;/li&gt;&lt;/ol&gt;


&lt;p&gt;Of course, there are still some pitfalls:&lt;/p&gt;

&lt;ol&gt;&lt;li&gt;They don't mirror the full production setup.  They're usually one box and not spec'd for any kind of load.  They run good, but not going to handle lots of people.  Can't perf test here.&lt;/li&gt;
&lt;li&gt;There is the data persistence between switching branches, but often no rich DB history.  It is harder to test large datasets of legacy type setups.&lt;/li&gt;
&lt;li&gt;Can't test infrastructure changes.  If deploys don't switch out gems or system configs, so harder if you want to test a change like that, you need to lock the environment til done.&lt;/li&gt;&lt;/ol&gt;


&lt;p&gt;All of this makes for a very flexible deployment process.  It allows devs to easily get code off of their machines and in a more controlled environment.  It allows us to have high confidence in code before it makes it to master and often even before the feature branch.  It also allows QA to do their testing without potentially deploying code they reject to staging or demo, where it might be customer facing or impact other development.&lt;/p&gt;

&lt;p&gt;Big props for it go to &lt;a href=&quot;http://twitter.com/mikewadhera&quot;&gt;@mikewadhera&lt;/a&gt;, who initially wrote the deployment process for it.  Since then, we (infra/ops team) have worked on making the environments single-system, which allow us to have more of them, as well as iterate on making them more streamlined with developer and QA feedback.&lt;/p&gt;

&lt;p&gt;This kind of builds up to something I'll be talking about soon too.  Since we have a total of 9 different environments, this can lead to a very interesting chef workflow.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Serving Static Content Via POST From Nginx</title>
      <link>http://invalidlogic.com/2011/04/12/serving-static-content-via-post-from-nginx/</link>
      <pubDate>Tue Apr 12 00:00:00 -0700 2011</pubDate>
      <guid>http://invalidlogic.com/archives/2011/04/12/serving-static-content-via-post-from-nginx/</guid>
      <description>&lt;p&gt;Recently, a change was made on Facebook's end where their &amp;lt;fb:iframe&gt; FBML tag started doing POST request to get content.  Their documentation seemed to indicate their &quot;Post for Canvas&quot; change wouldn't affect the &amp;lt;fb:iframe&gt; tag, however our error logs spoke quite to the contrary.  We saw an influx in errors in places where we used &amp;lt;fb:iframe&gt; to pull in static content.  Nginx would simply return a 405 error for &quot;Method Not Allowed&quot;.  Nginx can't serve static content on a POST request.&lt;/p&gt;

&lt;p&gt;Some quick googling seems to reveal some quick answers, but the problem is none of them worked.&lt;/p&gt;

&lt;p&gt;The most popular, &lt;a href=&quot;http://forum.nginx.org/read.php?2,2414,47301&quot;&gt;this thread&lt;/a&gt;, talks about a work around by manipulating the error page for nginx.  First, there is some mixed syntax depending on the nginx version.  Some references seem to be to old 2007 syntax which doesn't work on the nginx 0.7 build we use.  But they all indicated that this &lt;em&gt;should&lt;/em&gt; have worked:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;nginx&quot;&gt;&lt;span class=&quot;k&quot;&gt;error_page&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;405&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;@405&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;@405&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;


&lt;p&gt;This basically tells nginx to change the response code to 200 for 405 messages, and to use the @405 location entry to handle it.  Setting the root it is supposed to pull the requested document.  It didn't work though.  At best, I got it to return a 200 code, but no response body.  Essentially, it was still doing a POST request and it still didn't like it.&lt;/p&gt;

&lt;p&gt;I could however, get it to be served by proxying it to our Rails application, if I enabled serving static content from Rails.  But that was less than ideal.&lt;/p&gt;

&lt;p&gt;But then, I was scanning through nginx's &lt;a href=&quot;http://wiki.nginx.org/HttpProxyModule&quot;&gt;proxy documentation&lt;/a&gt; and found what seemed like an ideal solution.  I could configure nginx to serve static content on another port, have the main server proxy it to the other port, and when proxying, change it into a GET request:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;nginx&quot;&gt;&lt;span class=&quot;k&quot;&gt;upstream&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;static_backend&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;localhost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;89&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;...&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;error_page&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;405&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;@405&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;@405&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;proxy_method&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;proxy_pass&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;http://static_backend&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# POST STATIC CONTENT&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;listen&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;89&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;server_name&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;



</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Our pain points with EC2 and how our moved solved them</title>
      <link>http://invalidlogic.com/2011/02/16/our-pain-points-with-ec2/</link>
      <pubDate>Wed Feb 16 00:00:00 -0800 2011</pubDate>
      <guid>http://invalidlogic.com/archives/2011/02/16/our-pain-points-with-ec2/</guid>
      <description>&lt;p&gt;As I mentioned in my last post, we made the move off of EC2 in December to our own cluster of machines.&lt;/p&gt;

&lt;p&gt;While EC2 had served us very well and helped get our systems to the
place they are today, we started reaching a point where we were
running into three main bottlenecks with the EC2 ecosystem and we couldn't find any way around them.&lt;/p&gt;

&lt;p&gt;Will start off by saying the AWS is an awesome service and we couldn't
have grown to the level we are at today without them.  Amazon should
be a easy contender for any service just starting out.  Some of the
services they provide, especially things like Elastic Load Balancer
(ELB) and Elastic Block Storage (EBS) are services that are simple to
start using, help tremendously as you grow, and simply aren't common
with traditional VPS hosting.&lt;/p&gt;

&lt;p&gt;However, here are some of the bottlenecks we faced and how we've
solved them in our new setup.&lt;/p&gt;

&lt;h3&gt;IO Performance&lt;/h3&gt;

&lt;p&gt;Anyone who is doing anything intensive on EC2 will tell you that IO
performance is horrendous.  We were battling EBS constantly on our
database servers and had serious questions how we could continue to
operate yet alone scale our DBs while in the cloud.  We met with AWS engineers to review our configurations, but
were already doing all the best practices.  We had tuned MySQL
configuration as much
as we could, had the &quot;high-memory&quot; instances and higher IO priority
and newer CPUs,
and were running 4 EBS volumes in RAID10.&lt;/p&gt;

&lt;p&gt;They tried to push Amazon RDS, however RDS is simply EC2 and EBS with
the same best practices.  While it might be slightly better, it wasn't going to
totally solve our problems.&lt;/p&gt;

&lt;p&gt;The biggest issue was IO latency.  We had database servers where it
was normal for them to average 20-30% IO wait.  We frequently had
spikes upwards of 60% to sometimes 90%.&lt;/p&gt;

&lt;p&gt;And it wasn't always disk performance, but IO as a whole.  We would at times provision a
new database server that would simply struggle to stay fully
replicated with no query load on it.  Either struggling with IO
latency, or sometimes even keeping a connection up to the master.&lt;/p&gt;

&lt;p&gt;There is unfortunately no solution.  Everything in AWS is a shared
resource.  With that comes variable performance and bad spikes due to
hot-spots.  It is difficult to predict or ensure consistent
expectations.&lt;/p&gt;

&lt;h3&gt;Support&lt;/h3&gt;

&lt;p&gt;At one point, we encountered an issue where we were seeing extreme IO
latency on our EBS volumes on our master MySQL DB server.  One of our
other ops guys was up for several hours in the middle of the night,
along with our CTO and Director of Product.  Unfortunately it was an
EBS issue throughout the entire zone and we had a large footprint in
that zone, including our master database server.&lt;/p&gt;

&lt;p&gt;The biggest thing we took issue with was that it was almost 3 hours
before it actually made it to Amazon's status dashboard.&lt;/p&gt;

&lt;p&gt;After that incident, we started looking at Amazon's Premium support,
however the support packages are really quite weak when you dig into
them.&lt;/p&gt;

&lt;p&gt;First of all, Premium is a straight 20% added to your bill.  You can't
select it per instance or anything.  We didn't care about premium
support on our staging systems, so we'd have to move those to another
account if we signed up.&lt;/p&gt;

&lt;p&gt;But the big thing... you get 24/7 phone support and a 1 hour
acknowledgement SLA.  Meaning they'll confirm you are having an issue
within 1 hour.  However, resolution is another thing.  Because
everything in AWS are shared resources, they can't offer any sort of
priority resolution at all.&lt;/p&gt;

&lt;p&gt;So that EBS latency issue?  It took 3 hours to make their status
dashboard, and a total of 11 hour from when we noticed it to them
posting it was totally resolved.&lt;/p&gt;

&lt;p&gt;Paying for Premium support wouldn't have helped much.  It would still
be fixed for us at the same time.  At telling the CTO/Director &quot;AWS
has acknowledged it, it'll be fixed when its fixed&quot; isn't the type of
message we like to deliver.&lt;/p&gt;

&lt;h3&gt;Scaling Costs&lt;/h3&gt;

&lt;p&gt;Amazon is great for services just starting out.  It is simple pay-as-you-go, you get availability of a lot of nice functionality with S3,
Elastic Load Balancer, and others, and it is quick to get bigger instances
as you grow and need more.&lt;/p&gt;

&lt;p&gt;However there comes a threshold where the costs start growing more
quickly than your scale.&lt;/p&gt;

&lt;p&gt;Want support?  Bam, extra 10%-20%.&lt;/p&gt;

&lt;p&gt;IO bottlenecks?  Amazon's answer is to use bigger instances (higher IO
priority) and spread the load across multiple instances.  Both of those mean
more money.&lt;/p&gt;

&lt;p&gt;Once you start reaching bottlenecks, the only answer within AWS is to
work around them, and that usually means more costs.&lt;/p&gt;

&lt;p&gt;Additionally, since it is so easy to provision new systems, it is easy
to get carried away without realizing how much the changes are costing you.&lt;/p&gt;

&lt;h3&gt;Insight&lt;/h3&gt;

&lt;p&gt;This is actually a bottleneck we didn't really realize until after we
moved.  It is amazing how little insight you have into your
architecture until you have full control over it.&lt;/p&gt;

&lt;p&gt;For instance, on the new setup we had nice zone separation between
systems and were seeing massive spikes in concurrent connections
through the firewall, 3x more than we expected.  They all ended up
being DNS traffic.  Since it was UDP, the &quot;connection&quot; count was
skewed, but we hadn't realized how much DNS traffic we generated.  In
AWS, we couldn't monitor low level traffic metrics in the same way,
track our aggregate DNS traffic, or anything.&lt;/p&gt;

&lt;h3&gt;Our Solutions&lt;/h3&gt;

&lt;p&gt;Our solutions to all of these were actually quite simple and are a
nice blend between old school architecture and modern pragmatism.&lt;/p&gt;

&lt;p&gt;Nowadays, you start to hear all this stuff about &quot;private clouds&quot;.
First of all, drop the bullshit.  &quot;Cloud&quot; is slapped on anything it
can be these days.  There is nothing new to the concept of &quot;private clouds&quot;.&lt;/p&gt;

&lt;p&gt;All it is is a virtualization cluster on equipment dedicated to you.
Its been around for 10+ years.  Clouds caught on because they were
simple to get started with and great at the small scale.  Now its just
a marketing buzzword.&lt;/p&gt;

&lt;p&gt;Our approach was simple.  We separated our environment out into a
hybrid of dedicated systems for some things, and a large SAN backed
virtualization cluster for everything else.&lt;/p&gt;

&lt;h4&gt;Databases&lt;/h4&gt;

&lt;p&gt;Dedicated hardware is the perfect solution for IO intensive
workloads.  With this, we could actually specify what we wanted.
Types of disks, RAID configuration, capacity, etc.  We could go as
simple as RAID 10, up to SSD or even FusionIO.&lt;/p&gt;

&lt;p&gt;We moved all our MySQL and MongoDB systems to dedicated hardware, each
built to their own needs and planned ahead for a certain timeline.  We
then looked at several growth metrics.  For instance, MySQL would
likely need more CPU or disk capacity in the future.  MongoDB would
likely need more RAM in the future.&lt;/p&gt;

&lt;h4&gt;Virtualization&lt;/h4&gt;

&lt;p&gt;Almost everything else was virtualization.  We got several very big,
bulky virtualization systems.  12 cores, 24 threads, 128gb RAM, ohh
yeah.  However we slice and dice it is up to us.  We have everything
configured for full failover of the base chassis.&lt;/p&gt;

&lt;p&gt;At the SAN level, we left that up to the guys at Network Redux.  They
monitor the workload levels and plan for it accordingly.  The IO
doesn't scale infinitely, but rather we try to maintain an average
expectation so that growth is predictable.&lt;/p&gt;

&lt;h4&gt;Support&lt;/h4&gt;

&lt;p&gt;Support is probably one the biggest and most dramatic changes.  AWS is
a complete black box.  Now, we have two people dedicated to our
account, as well as a 24 support desk we can call and have a tech pull
up all the details on our account.  We have the cellphone numbers of
the people dedicated to our account.  We have yet to call them at 2am,
however having it is more than we ever had with Amazon.&lt;/p&gt;

&lt;p&gt;We now have people proactively working to help us.  If IO load is
growing on the SAN, they reach out to us ahead of time, before it
becomes a problem on our end.&lt;/p&gt;

&lt;p&gt;If a hardware node throws an alert, they get paged at the same time
and will hop online to help us to investigate.&lt;/p&gt;

&lt;p&gt;This is probably one of the biggest pros and our new provider, &lt;a href=&quot;http://networkredux.com/&quot;&gt;Network Redux&lt;/a&gt; has been truly awesome in that regard.  They are proactive, we deal with the same people over time so they are familiar with our deployment, our change history, etc.&lt;/p&gt;

&lt;h4&gt;Costs&lt;/h4&gt;

&lt;p&gt;Costs though... surely all this raw hardware goodness, scalable IO,
and choice in your deployment costs a whole lot extra, doesn't it?
Not so.  You might actually be surprised how much cheaper it is.  I
can't give numbers, but I will say it was &lt;em&gt;significant&lt;/em&gt; and after the
move one of the main bullet points added by the CFO was &lt;em&gt;how much&lt;/em&gt;
cheaper it was.&lt;/p&gt;

&lt;p&gt;To make the CFO even happier, we had planned ahead for growth, where
we could handle spikes and add some additional systems without extra
costs, and had solid figured on how much the costs would increase.
&quot;When we need more capacity here, the next step is X, and the cost
will be $Y.&quot;  As more time goes on, we're getting better at predicting
when the growth will be needed, and showing the benefits.&lt;/p&gt;

&lt;h3&gt;Conclusions&lt;/h3&gt;

&lt;p&gt;Overall, Amazon is great service.  Don't get me wrong.  It is truly
excellent for companies/services just starting out and has an awesome
growth path for scaling early on.&lt;/p&gt;

&lt;p&gt;However nothing scales infinitely.  Not your applications, and not the
benefits of a service like AWS.&lt;/p&gt;

&lt;p&gt;Once you each a certain threshold, you benefit more from full control
over your environment and you get to the point where it is actually
cheaper than the cookie cutter services AWS provides.  Where that
threshold is depends on each case.  But it is important to know where
it is, even if you aren't there yet.&lt;/p&gt;

&lt;p&gt;For us, we improved our performance several times over, have more
control than ever, and did it all while actually saving money.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>How we did a datacenter migration with no downtime</title>
      <link>http://invalidlogic.com/2011/02/11/how-we-did-a-datacenter-migration-with-no-downtime/</link>
      <pubDate>Fri Feb 11 00:00:00 -0800 2011</pubDate>
      <guid>http://invalidlogic.com/archives/2011/02/11/how-we-did-a-datacenter-migration-with-no-downtime/</guid>
      <description>&lt;p&gt;Starting in October, we at Involver decided to take on a project migrate our entire infrasture off of Amazon EC2.  AWS had served us well, however there comes a point where the limitations of some of their services were becoming a major bottleneck.  The bottlenecks and how we've resolved them in our migration is a big enough topic for a follow up post, but we recognized that we needed more control over our environment and the specifications of all the systems.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; Have posted the follow up on the &lt;a href=&quot;/2011/02/16/our-pain-points-with-ec2/&quot;&gt;bottlenecks we were facing EC2&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After nearly a month of evaluating providers, doing benchmarks on test systems, and milling over all the details, we picked our provider.  We then spent another month refactoring various systems, re-evaluating all machine roles, and system configurations.  Since we were no longer constrained by EC2 instance types, we started looking at how many CPUs and how much RAM is really best suited for each system.&lt;/p&gt;

&lt;p&gt;For our hosting provider, we ended up going with &lt;a href=&quot;http://networkredux.com&quot;&gt;Network Redux&lt;/a&gt;.  Of all the others, both big names you'd recognized and some smaller ones you wouldn't, they proved the best fit.  Go to any provider and they can all get you the same server.  That is easy.  Its the other services, the skills of their staff, and quality of the total, big picture architecture that matters.  With Network Redux, a lot of it came down to the fact they they worked like us.  They hired top-notch people, they moved quickly on things, and had a short decision tree.  Case in point, when the President is on your sales call and can say you'll have a test system with set specs in two days, vs the sales person needing to pull out an org chart and &quot;get back to you.&quot;&lt;/p&gt;

&lt;p&gt;After our month of refactoring, we finally flipped the switch the night of December 23rd.  We did an entire datacenter migration with no user downtime.  Even more, we didn't even have all of our production systems until that morning (thanks Dell! &amp;lt;/sarcasm&amp;gt;).&lt;/p&gt;

&lt;p&gt;So how did we pull it off?&lt;/p&gt;

&lt;p&gt;It boils down to an excellent team, delicate planning, and an awesome toolset.  Our operations team is only 3 people, but we manage what is now 8 environments where our code lives and about 100 systems.&lt;/p&gt;

&lt;p&gt;Everything in our environment is fully configured with chef.  With the migration, we refactored a lot of our recipes put a strong emphasis on everything in chef.  Each system was provisioned, cooked and recipes tweaked, then destroyed, reprovisioned, and recooked.  Repeated until it was ready to go right after cooking.&lt;/p&gt;

&lt;h3&gt;MySQL&lt;/h3&gt;

&lt;p&gt;Our production database servers were the first to get set up on the production side.  We'd already validated all our chef recipes for both our MySQL and our MongoDB clusters on our staging environment beforehand.  With MySQL, we run a master-master setup with multiple read-only slaves.  We cooked each of the boxes and configured all of the slaves to point to what would be the new master.  We made a change to ensure that the new master and the EC2 master had different auto-increment offset and we also ensured log_slave_updates was enabled.  We then imported a backup of our production database onto the new master.  It automatically replicated out to the passive master and read-only slaves.  We then set it up so our new master would replicate from our EC2 master.&lt;/p&gt;

&lt;p&gt;With this configuration, writes would be coming in on our EC2 master, get replicated to the new master, and since it has log_slave_updates on, those changes would then replicate our to the other database servers.  This also enabled us to switch over the site and easily allow writes to start coming in to the new environment.  If there were some lagging requests to the old site, they would replicate to the new environment without any collisions.  We also documented the position of the new master when the switch happened, so if we needed to revert, we could potentially set the EC2 master to replicate from the other master.&lt;/p&gt;

&lt;h3&gt;MongoDB&lt;/h3&gt;

&lt;p&gt;The MongoDB databases were migrated in a different fashion.  We were moving from a single replica set configuration to a sharded setup with two replica sets.  Because of this, we could do the same early replication process we did with MySQL.  Mongo is primarily used for our analytics data, so with it, there is a primary collection that is most important and then others used for the calculations.  We cooked the database servers ahead of time and got the sharding configuration and everything fully setup before hand.  Then the data migration was scripted out so that with a quick command, we would pull the most important data over first by exporting the data, transferring it, then importing it.  This way, it was migrated and sharded at the same time and fully automated.&lt;/p&gt;

&lt;h3&gt;Our Application&lt;/h3&gt;

&lt;p&gt;The morning of the 23rd, we came in, having just had the bulk of our production virtualization cluster setup the night before (thanks again for the delay Dell).  This is where the awesomeness of chef and our team truly shined.  We set to work and provisioned all of the production systems, cooked them, set them up in load balancing, verified security rules, and completed some of the final code tweaks and testing.  We didn't even deploy our final monitoring systems until that morning.   We did a few test deploys, verified all the parts of the app would come up, and that monitoring on them was accurate.&lt;/p&gt;

&lt;h3&gt;The Switch&lt;/h3&gt;

&lt;p&gt;Finally, around 10:45pm, we made the switch.  The actual cut off boiled down to just a DNS change.  TTLs had been changed to 60 seconds weeks earlier.  We just repointed the necessary hosts and within 60 seconds, we saw the majority of traffic cease on EC2 and come in on our new systems.&lt;/p&gt;

&lt;p&gt;Right after we made the DNS change, we also removed all of our old app servers from ELB (Elastic Load Balancer) except for two.  We turned nginx off on those two and turned on &lt;a href=&quot;/2010/02/12/migrating-datacenters-how-to-forward-traffic&quot;&gt;rinetd&lt;/a&gt;, which was already configured to forward any traffic to port 80 or 443 to our new environment.&lt;/p&gt;

&lt;p&gt;The benefits of the migration were almost instantly visible.  Noah, our CTO, was in the office with us to do acceptance testing right afterward.  We made the switch, verified DNS had updated, and when he loaded the first page, his first reaction was &quot;Holy shit... this is so much faster!&quot;  That there was all the validation we needed for the 2 months of work we had put in.&lt;/p&gt;

&lt;p&gt;Most impressive was looking back at data in New Relic from before and after the migration.  It was quite surprising how drastic the improvement was.&lt;/p&gt;

&lt;div style=&quot;text-align: center&quot;&gt;&lt;img src=&quot;http://invalidlogic-blog.s3.amazonaws.com/redux-switch.jpg&quot; width=&quot;647&quot; height=&quot;264&quot; /&gt;&lt;/div&gt;


&lt;p&gt;And its gotten even better.  Having to no longer fight fires with AWS anymore, we've actually made tons of other enhancements.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>How a deprecated method can take down a process</title>
      <link>http://invalidlogic.com/2011/02/07/how-a-deprecated-method-can-take-down-a-process/</link>
      <pubDate>Mon Feb 07 00:00:00 -0800 2011</pubDate>
      <guid>http://invalidlogic.com/archives/2011/02/07/how-a-deprecated-method-can-take-down-a-process/</guid>
      <description>&lt;p&gt;At Involver, we have a pretty active background processing tier that handles a variety of things from long running tasks we don't want in the web app, pulling in content from external sources, and simple recurring maintenance tasks.&lt;/p&gt;

&lt;p&gt;Previously, we ran a single worker thread per JVM, but that setup lead to a low worker per system density since it sucked up a lot of memory.  A few months ago, we came up with a way to run multiple workers within a single JVM and have it nicely thread safe by using a small embeddable JRuby VM started off the main process.  This worked excellent and doubled the number of workers we could run per machine, since they could share heap space.&lt;/p&gt;

&lt;p&gt;But then we recently began experiencing an issue where all the threads would just halt processing.  No errors, seemingly nothing wrong.  Heap usage was fine and a thread dump showed them seemingly ok, but they just sat.  We tried attaching a profiled, however it ended up just output garbage when we tried to have to dump its data after it got stuck.&lt;/p&gt;

&lt;p&gt;After 2 days of investigation, finally managed to tracked the cause down to the fact that a change a few days before had caused us to start running over a function that used a deprecated method call, and the change meant we were hitting that line 500-1000 times per minute.&lt;/p&gt;

&lt;div style=&quot;float:right; margin-top: 5px; margin-left: 10px; margin-bottom: 5px&quot;&gt;&lt;img src=&quot;http://invalidlogic-blog.s3.amazonaws.com/gru-light-bulb.jpg&quot; width=&quot;400&quot; height=&quot;231&quot; title=&quot;not a light bulb, but still very shiny&quot; /&gt;&lt;/div&gt;


&lt;p&gt;At first, we suspected maybe JRuby had some sort of thread concurrency issue with calling deprecated methods, but that made no sense.  All calling a deprecated method does is write to the console!&lt;/p&gt;

&lt;p&gt;As Gru in Despicable Me would say... &quot;Light bulb!&quot;&lt;/p&gt;

&lt;p&gt;When running a single worker in console, we saw the warnings, but when running the multiple workers per JVM, we saw none.  The rabbit hole gets deeper and fortunately lead us to the solution and were able to confirm the issue and resolution.&lt;/p&gt;

&lt;p&gt;The way we spawned the child threads, we found stdout/stderror was not attached to anything.  They make use of buffered IO though.  There is a fixed buffer size, and if you try writing more than that, it will block on writing to it until the buffer is read from and space is freed.  Since nothing was reading from it though, the threads would simply block indefinitely on writing out the deprecated method calls.&lt;/p&gt;

&lt;p&gt;So we set up a test.  We created the following class on one of our boxes and spawned up the multi-worker process.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Awesome&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;kill_me_softly&lt;/span&gt;
    &lt;span class=&quot;kp&quot;&gt;loop&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;nb&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;info&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;Alive!&amp;#39;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;


&lt;p&gt;It came up, but would get hung in less than a second.  Simply do no more.  One threads would lock up independently, one by one.  So the whole JVM wasn't frozen, just that child thread.  Hence why they all died at different times, but very close together.&lt;/p&gt;

&lt;p&gt;Then to confirm even more and fix it, we changed the multi-worker process to reopen the stdio handlers on child threads:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;&lt;span class=&quot;no&quot;&gt;STDIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;/dev/null&amp;quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;STDOUT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;/dev/null&amp;quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;STDERR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;/dev/null&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;


&lt;p&gt;Spawn one back up, and it begins streaming to no end, no lock ups, no problems.  Success!&lt;/p&gt;

&lt;p&gt;In the end, we changed the function to no longer use the deprecated method, and had the multi-worker process redirect stdio for child processes to an actual file, so that way we can actually log any valuables messages we might be otherwise missing.  But that is hopefully the first and only time something as off as stdio buffering takes down a process.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Love your dependency management</title>
      <link>http://invalidlogic.com/2011/01/19/love-your-dependency-management/</link>
      <pubDate>Wed Jan 19 00:00:00 -0800 2011</pubDate>
      <guid>http://invalidlogic.com/archives/2011/01/19/love-your-dependency-management/</guid>
      <description>&lt;p&gt;Dependency management is a pain in the ass, but it doesn't have to be.&lt;/p&gt;

&lt;p&gt;Last month we went through a full migration of all of our systems to a new provider.  This is truly awesome to do when you have all your systems spec'd out and managed with chef, however it can also highlight those areas you might have been lazy or where you didn't enforce your chef specs enough.  We managed to catch a few places where a smaller satellite app had newer system gems installed and not documented in its readme or in our chef specs.&lt;/p&gt;

&lt;p&gt;Managing gems is one of those areas that you find varying opinions, but I've definitely fallen in love with &lt;a href=&quot;http://gembundler.com&quot;&gt;bundler&lt;/a&gt; over the past year.  I use it on all my personal projects, but it becomes even more valuable when used within a team of developers.  Need to change a gem?  Just do it and notify everyone to run bundle install.  Often times, bundler will actually tell them they need to update if it sees changes.  Time to deploy your changes?  That is all you do... deploy them!&lt;/p&gt;

&lt;p&gt;Before, we had a mixture of vendored gems and system gems depending on whether some were using C extensions or needed to have system binaries.  But by moving these applications to use bundler, the only gem chef needs to install is bundler itself.&lt;/p&gt;

&lt;p&gt;The easing of the process for both sides is awesome... both for the devs and for operations.&lt;/p&gt;

&lt;p&gt;Tired of your own gem deploy or dependency management woes?  Take a look... wouldn't hurt.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Progress through iterating</title>
      <link>http://invalidlogic.com/2010/12/08/progress-through-iterating/</link>
      <pubDate>Wed Dec 08 00:00:00 -0800 2010</pubDate>
      <guid>http://invalidlogic.com/archives/2010/12/08/progress-through-iterating/</guid>
      <description>&lt;p&gt;It was a little over a year ago that I launched the public beta of Trunks, and when talking with a friend was looking back at all the revisions it has gone though.  Although its only been live a year, I've actually been working on the project for 3 years now and I'm on the 4th major revision of its codebase.&lt;/p&gt;

&lt;p&gt;The projects that are most fulfilling long-term are those that you have a vested interest in.  Often times, they're beyond purely financial.  I have never gauged Trunk's success on its profits, rather it is an idea that I myself find value in, and believe others do as well.  That is why I've stuck with it over time.&lt;/p&gt;

&lt;p&gt;Each major revision has addressed problem areas of the previous and has gotten incrementally better and more mature.  When looking back, can clearly see the problem points of the previous version and how they were addressed.  It is important to look back to see the path you've traveled.  Be aware of the mistake you've already addressed so as to not re-introduce them.  And if nothing else, feel proud of the investment you've made in the project and you own growth.&lt;/p&gt;

&lt;p&gt;I had basically forgotten I'd been working on Trunks for 3 years.  After being reminded, was looking at it and thinking damn, its come a long way.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Tool Enlightenment, Part 2</title>
      <link>http://invalidlogic.com/2010/10/25/tool-enlightenment-part-2/</link>
      <pubDate>Mon Oct 25 00:00:00 -0700 2010</pubDate>
      <guid>http://invalidlogic.com/archives/2010/10/25/tool-enlightenment-part-2/</guid>
      <description>&lt;p&gt;I started typing a follow up post about my experiences with vim, but then as I was adding a line about not throwing gasoline on the holy war that I was doing exactly that.  I was creating the stereotypical holy war inflamatory post.&lt;/p&gt;

&lt;p&gt;My main point in the previous post was about finding the tools that worked best for you, and ignoring the FUD from everyone else.&lt;/p&gt;

&lt;p&gt;So with that, I spent a week with vim, watched several screencasts, pulled in several plugins, and gave it a solid week of not using emacs and resisting TextMate.  At the end of that week, I've decided I'm more at home in emacs.&lt;/p&gt;

&lt;p&gt;The reasons are basically mute, especially since I'm trying to push for people to find out for themselves.  It is counter intuitive to give a now slanted opinion while telling you to ignore it.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Tool Enlightenment</title>
      <link>http://invalidlogic.com/2010/10/14/tool-enlightenment/</link>
      <pubDate>Thu Oct 14 00:00:00 -0700 2010</pubDate>
      <guid>http://invalidlogic.com/archives/2010/10/14/tool-enlightenment/</guid>
      <description>&lt;p&gt;Recently, I decided to take a journey down the path of enlightenment.&lt;/p&gt;

&lt;p&gt;One of the things I found so refreshing about Ruby/Rails when I first started using it was the simplicity of the tooling.  Just use a text editor, no monolithic IDE with large memory footprints, slow load times, and a panache for crashing.&lt;/p&gt;

&lt;p&gt;Visual Studio certainly is a great tool, and provides some powerful tools to .NET.  But I doubt anyone would disagree with me that Visual Studio often feels like a 500lb gorilla. Especially when you add in the plugins so many use, like CodeRush or ReSharper.  Simply opening TextMate was rather refreshing when coming from that kind of environment.&lt;/p&gt;

&lt;p&gt;A few weeks ago, I had the chance to go to &lt;a href=&quot;http://gogaruco.com&quot;&gt;GoGaRuCo&lt;/a&gt; and they had a workflow panel where they got some of the well known developers up on the stage, and discussed some of the tools and arrangements they use.  It was a little superficial, where it was &quot;I have an editor with 3 panes and 2 terminals open&quot;.  But there were some interesting observations.  First of all, everyone on the panel was using either Emacs or Vim.  After the talk, they polled the audience what they use.  The overwhelming majority of the audience was using either RubyMine or TextMate.&lt;/p&gt;

&lt;p&gt;The surface argument you could make is that all the &quot;hackers&quot; are using Emacs/Vim and aren't representative of the population.  Sure, I looked at it that way too.  But a few things started to peak my interest, particularly when I'd talk to an Emacs or Vim user.  You will almost always hear them say they've been using it for 10 years, 15 years, or sometimes even longer.&lt;/p&gt;

&lt;p&gt;Think about your toolset today and your toolset 10 years ago.  Is there &lt;i&gt;anything&lt;/i&gt; that you're still using?  If so many people will stick with the same tool for 10 years, spanning technology bubbles, and crossing over to new languages, there must be something that tool is doing right.  These are tools whose users invest in them.  They're like marriages.&lt;/p&gt;

&lt;p&gt;So my journey to enlightenment has begun with looking at Emacs, however I'm not just playing eenie-meenie-miney-moe. Both Emacs and Vim have large followings are both excellent choices. The way I see it, I can't chose which direction to go without looking both ways.  So, I'm trying both for 1-2 weeks each, play around with building my .emacs and vimrc, and see where it leads.&lt;/p&gt;

&lt;p&gt;I've been using Emacs for almost 2 weeks now, and find myself opening stuff up in TextMate less and less.  Next week, I plan to focus more on Vim and try it out.&lt;/p&gt;

&lt;p&gt;But I think the true enlightenment that can be found is... the elite tools are not what the &quot;hacker&quot; portion of a community use.  Use what fits your style best, understand why you've chosen your tools, and recognize those same decisions in the tools used by those around you.&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
    <item>
      <title>Involver Team and Matz</title>
      <link>http://invalidlogic.com/2010/10/08/involver-team-and-matz/</link>
      <pubDate>Fri Oct 08 00:00:00 -0700 2010</pubDate>
      <guid>http://invalidlogic.com/archives/2010/10/08/involver-team-and-matz/</guid>
      <description>&lt;p&gt;Yukihiro &quot;Matz&quot; Matsumoto was speaking yesterday at the &lt;a href=&quot;http://www.twilio.com/&quot;&gt;Twilio&lt;/a&gt; offices in San Francisco on what is coming in Ruby 2.0.  Was a great time and was a pleasure to meet Matz in person.  I love to meet people who have changed the industry, but still remain humble.  He was very polite, thanking us for coming, shaking hands, meanwhile everyone was thanking him for Ruby.&lt;/p&gt;

&lt;p&gt;One of the great question after the presentation was someone asking him what it is like having, basically, changed development and how it felt when he first realized it was catching on.  Matz said that time was around when the first picaxe book came out.  It was having someone other than himself writing an English book about Ruby and it selling well.  But his general answer to what it was like was &quot;its nice&quot;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://invalidlogic-blog.s3.amazonaws.com/100_0098_2.jpg&quot; alt=&quot;&quot; title=&quot;100_0098_2&quot; width=&quot;640&quot; height=&quot;480&quot; class=&quot;aligncenter size-full wp-image-609&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The Involver team had the opportunity to take a bit of a team photo with him.  This represents about a quarter of the total Involver Engineering team.  Here we have &lt;a href=&quot;http://twitter.com/zedlander&quot;&gt;@zedlander&lt;/a&gt;, Jaime our System Overlord, myself, Nina our QA queen, and &lt;a href=&quot;http://twitter.com/zquestz&quot;&gt;@zquestz&lt;/a&gt; (aka Josh) who just started this week.  &lt;a href=&quot;http://twitter.com/nolamn&quot;&gt;@nolman&lt;/a&gt; was also there, but had to take off right after the talk.&lt;/p&gt;

&lt;p&gt;Ruby 2.0 will have a number of small but very nice language improvements, such as keyword arguments (similar to what .NET 4.0 added), as well as the ability to namespace things, including monkey patching that is scoped to only the namespace.  That there is something that seems like it will bring a lot of power.  Use two libraries that use two different versions of a gem?  What if you could load them in separate namepaces, each utilizing the separate gem versions.  Perhaps you could get really crazy and have a Rails 2 and Rails 3 app running together using separate namespaces.  I don't know why anyone would do that, but you could, and that I like.&lt;/p&gt;

&lt;p&gt;Ruby 2.0 will see a large emphasis on embedded and an alternative VM/interpretter for more targeted implementations.  I would love it if we could have a setup similar to the Arudio or Neturdio that ran Ruby.  Matz was talking about bringing Ruby to places like digital appliances, more RTOS environments focusing on latency instead of throughput.  Or having Ruby implementations for the cloud that utilized a smaller subset of the language to run on more targeted hardware.  Distributed processing where perhaps computational power is more important than IO or what not.&lt;/p&gt;

&lt;p&gt;My first thought... in a few years, could my DVR be running a Rails web interface?&lt;/p&gt;
</description>
      <creativeCommons:license>http://creativecommons.org/licenses/by-nc-sa/3.0/</creativeCommons:license>
    </item>
    
  </channel>
</rss>