<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head profile="http://gmpg.org/xfn/11">
    <title>TC5.0 Search: Adding your own types, part 2 &mdash; In Valid Logic</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Endlessly expanding technology" />
    <meta name="author" content="Ken Robertson" />
    <meta name="generator" content="jekyll" />

    <link href="/css/site.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/css/pygments/trac.css" rel="stylesheet" type="text/css" media="screen" />

    <link href="/atom.xml" rel="alternate" title="Ken Robertson's Atom Feed" type="application/atom+xml" />
    <link href="/rss.xml" rel="alternate" title="Ken Robertson's RSS Feed" type="application/rss+xml" />

    <link rel='index' title='In Valid Logic' href='http://invalidlogic.com/' />
  </head>

<body>
  <div id="container" class="group">

    <h1><a href="http://invalidlogic.com">In Valid Logic</a></h1>
    <div id="bubble"><p>Endlessly expanding technology</p></div>

    <div id="content" class="group">
      <h2>TC5.0 Search: Adding your own types, part 2</h2>

<div class="main">
  <p>In this post, I'll cover the specifics of the search mappers.  Lets say we have a class named Book and we want to index it along with everything else Telligent Community normally indexes.  I'd first create a project called BookSample and add a reference to the Telligent.Search.Mapping assembly.</p>


<p>Mappers are classes that inherit from the Telligent.Search.Mapping.DocumentMapper class.  They have to implement two pieces, a Load() method and a Priority getter.  The Load() method is used to define function blocks that are later executed to perform the mapping.  The priority is to allow some overriding over the mapping process.  The mappers allows support inheritance, so you could define a mapper for a Post (even though Post is an abstract class), and you could also define one for ForumPost.  When a ForumPost object is mapper, both will be executed.</p>


<p>Additionally, you can define multiple mappers for the same type and the order of execution is set with the Priority value.  All built-in mappers have a priority of 10, so if you wanted all post bodies to be indexed in lower case (for instance), you could define a mapper with a priority of 20, so it will run after the default one, remove the Body field, and then re-add it as lower case.</p>


<p>Our Book search mapper would look something like this:</p>


<pre class="brush: c-sharp;">
using Telligent.Search.Mapping;

namespace BookSample
{
  public class BookMapper : DocumentMapper
  {
    public override void Load()
    {
      Map&lt;Book&gt;(book =&gt;
        {
          book.ISBN.MapTo(&quot;ISBN&quot;).Key();
          book.Title.MapTo(&quot;Title&quot;);
          book.Description.MapTo(&quot;Description&quot;);
          book.Author.Name.MapTo(&quot;AuthorName&quot;);
          book.Price.ToString(&quot;0.##&quot;).MapTo(&quot;Price&quot;);
        });

      Rehydrate&lt;Book&gt;(isbn =&gt; Books.GetByIsbn(isbn));
    }

    public override int Priority
    {
      get { return 10; }
    }
  }
}</pre>


<p>A few things to note:</p>


<ol>
    <li>The Load() method includes calls to the Map<t>() and Rehydrate<t>() methods, where you define an Action/Func block for the corresponding type.  This may sound funky, since we have gotten some questions about why we just didn't have something like DocumentMapper<t>.  We didn't really want to limit a mapper definition to a single type, we wanted them to be more &quot;scriptable&quot;, where you could clear or remove existing mappings and redefine your own, and we wanted a more fluent syntax so Map<book> says &quot;I'm mapping a Book&quot; where Map<author> says &quot;I'm mapping an Author&quot;.  It could have been done either way, we just ended up with it this way.</author></book></t></t></t></li>
    <li>In the Map call, you are passed in a variable which is the actual object you will be mapping.  The action block is called at a later time, and when it is, the Book that needs mapping will be passed in, so you can access is just as you would anywhere else in your code.  To add a field onto the search document, all you need to do is use the MapTo() extension method on whatever you want to add and specify its name in the search document.  So we have a property for book.Title and in the search document we want it named &quot;Title&quot;, so we call book.Title.MapTo(&quot;Title&quot;).</li>
    <li>All search documents need a Key.  This is whatever the original ID was of the object.  If and object is mapped and none of its mappers set a Key, it will throw an exception.  This is required because if the object is later reindexed, it uses a combination of the type (Book) and the key (the ISBN value) to remove the old document from the index and add the new one.  Additionally, we provide a way so if you have a search document, you can &quot;rehydrate&quot; it and get the original object (see later points).</li>
    <li>Again, the MapTo just needs to be whatever final value you want added, so if you want to add something from another object, just access it.  In this case, book.Author represents another class type.  We don't want to index it, we just want to include the author's name.  All you need to do is call book.Author.Name and then use MapTo on it.  In most cases, our fields in the search document map the property name, but in this case we want to use &quot;AuthorName&quot; so it is a clearer it doesn't relate to the book.</li>
    <li>And for a third time, MapTo is called on the value, so it can also be manipulated.  With book.Price, it is a double and we always want it indexed with two decimal places.  Simply need to call the ToString() on it and format it how you wish, then call MapTo on that.</li>
    <li>MapTo can be used on any type, as it is an extension method for &quot;object&quot; and not just common types like string, int, etc.  However, if MapTo is not a string, it will call ToString() on it to convert it.  This is to make the mappings a little less verbose like post.PostID.ToString().MapTo(&quot;PostID&quot;), but it also means it will adhere to some defaults and if you want a specific format, you need to convert it yourself.  Additionally, if you try to map a custom class, like the Author one mentioned earlier, it will call Author.ToString(), which if you haven't defined in your class, the field will likely be useless to you.</li>
    <li>And finally, after the call to Map<book>, we also define Rehydrate<book>.  This takes the key we previously set in the mapping, and allows to you define a function that can take that original key and return your object.  This is useful in cases where you have a search document representing the Book, but want the full object.  Be aware though, it can have performance costs.  If you have 20 search results and look through each one, rehydrating them to display some data, that might be 20 DB calls.</book></book></li>
</ol>


<p>In the next post, will go over how to implement the content handler for your new type.</p>




</div>

<div class="meta group">
  <div class="signature">
    <p>Tuesday, August 11, 2009</p>
  </div>	
  <div class="tags">
    &nbsp;
  </div>
</div>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2009/08/11/tc5-0-search-adding-your-own-types-part-1/" title="Previous post: TC5.0 Search: Adding your own types, part 1">TC5.0 Search: Adding your own types, part 1</a></div>
  
  
  
    <div class="next"><a class="next" href="/2009/09/15/the-joys-of-bnx2-on-debian-lenny-with-dell-servers/" title="Next post: The joys of bnx2 on Debian Lenny with Dell servers">The joys of bnx2 on Debian Lenny with Dell servers</a> &rarr;</div>
  
</div>
    </div>

    <div id="sidebar">
      <h3>About</h3>
      <div class="textwidget">
        This is the personal blog of Ken Robertson.  I'm a developer at <a href="http://involver.com/">Involver</a> working in Ruby/Rails.  In a former life, I worked in .NET for many years and since moved on.<br/>
        <br/>
        In my spare time, I like to build things.  I like to experiment with different technologies to find how they best fit onto my utility belt.<br/>
        <br/>
        I sometimes blog.  You'll find those things here.<br/>
        <br/>
        I sometimes code.  You'll find those on <a href="http://github.com/krobertson">Github</a>.<br/>
      </div>

      <h3>Search</h3>
      <form method="get" action="http://www.google.com/search">
        <div>
          <label class="screen-reader-text" for="s">Search for:</label>
          <input type="text" id="s" name="q" value="" />
          <input type="hidden" name="q" value="site:jon.smajda.com" />
          <input type="submit" id="searchsubmit" value="Search" />
        </div>
      </form>

      <h3>Recent Posts</h3>
      <ul>
        
          <li><a href="/2010/10/25/tool-enlightenment-part-2/">Tool Enlightenment, Part 2</a></li>
        
          <li><a href="/2010/10/14/tool-enlightenment/">Tool Enlightenment</a></li>
        
          <li><a href="/2010/10/08/involver-team-and-matz/">Involver Team and Matz</a></li>
        
          <li><a href="/2010/09/16/you-got-rvm-and-git-in-my-command-prompt/">You got RVM and git in my command prompt!</a></li>
        
          <li><a href="/2010/09/08/the-future-of-papercut/">The Future of Papercut</a></li>
        
    	</ul>
    </div>

  </div>

  <div id="footer">
    <p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a> &mdash; Built for <a href="http://wordpress.org/">WordPress</a></p>
  </div>

<!--
    <div id="nav">
            <h1><a href="/">In Valid Logic</a></h1>

            <ul>
                <li><a href="/archive/">Archive</a></li>
                <li><a href="/about/">About This Blog</a></li>
                <li><a href="/rss.xml">RSS</a> | <a href="/atom.xml">Atom</a></li>
            </ul>


            <h3>about me</h3>
            <p>I am a PhD candidate in sociology at the 
              <a href="http://www.soc.umn.edu">University of Minnesota</a>. I work for 
              <a href="http://contexts.org">Contexts</a>.</p>

            <h3>more me</h3>

            <ul>
                <li><a title="smajda.tumblr.com" href="http://smajda.tumblr.com">tumblr</a></li>
                <li><a title="@smajda on twitter" href="http://twitter.com/smajda">twitter</a></li>
                <li><a title="facebook.com/jonsmajda" href="http://facebook.com/jonsmajda">facebook</a></li>
                <li><a title="I do try" href="http://github.com/smajda">github</a></li>
                <li><a title="Silly music" href="http://soundcloud.com/smajda">soundcloud</a></li>
            </ul>

            <h3>aggregate feed</h3>
            <p>I made <a href="http://files.smajda.com/jon/feeds/aggregate/">an aggregate feed</a> of all my online activity. (I made it using <a href="http://simplepie.org/">SimplePie</a>. You can <a href="http://gist.github.com/204194">get the code here</a>.)</p>


    </div>

    <div id="content">


    <div id="footer">
        <p>The content of this site is licensed under a <br /><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/">Creative Commons Attribution-Noncommercial-Share Alike 3.0 license</a>.</p>

    </div>

    </div>
-->
</body>
</html>