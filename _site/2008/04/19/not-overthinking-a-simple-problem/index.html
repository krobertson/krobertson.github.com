<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head profile="http://gmpg.org/xfn/11">
    <title>Not overthinking a simple problem &mdash; In Valid Logic</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Endlessly expanding technology" />
    <meta name="author" content="Ken Robertson" />
    <meta name="generator" content="jekyll" />

    <link href="/css/site.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/css/pygments/trac.css" rel="stylesheet" type="text/css" media="screen" />

    <link href="/atom.xml" rel="alternate" title="Ken Robertson's Atom Feed" type="application/atom+xml" />
    <link href="/rss.xml" rel="alternate" title="Ken Robertson's RSS Feed" type="application/rss+xml" />

    <link rel='index' title='In Valid Logic' href='http://invalidlogic.com/' />
  </head>

<body>
  <div id="container" class="group">

    <h1><a href="http://invalidlogic.com">In Valid Logic</a></h1>
    <div id="bubble"><p>Endlessly expanding technology</p></div>

    <div id="content" class="group">
      <h2>Not overthinking a simple problem</h2>

<div class="main">
  <p>One little project I had taken up recently was to get <a href="http://thoughtbot.com/">Thoughtbot's</a> <a href="http://thoughtbot.com/projects/paperclip">Paperclip</a> plugin working under Merb and DataMapper.  Initially, what I wanted to do was to was implement it completely as a DataMapper custom type.  Basically, I wanted this as the class definition:</p>


<pre><code class="ruby">class User<br />  include DataMapper::Resource<br /><br />  property :id, Fixnum, :serial =&gt; true<br />  property :username, String<br />  property :avatar, Paperclip::Attachment,<br />                    :styles =&gt; { :medium =&gt; &quot;300x300&gt;&quot;,<br />                                 :thumb =&gt; &quot;100x100&gt;&quot; }<br />end</code></pre>


<p>With this, it would all be contained as a single column in the database and it would serialize the attributes to JSON (though initially used YAML).</p>


<p>The problem?  Initially, a custom type didn't know about how it was being used at all, such as what the model's name was and what the property's name was.  The object model basically went Model &lt;-&gt; Property -&gt; Type.  You could get to the model from the property, but couldn't get to the type.  I changed that with my recent contribution and was well on my way to finishing.  I got it so you could save, post-pone thumbnails til saving, validations, and all.  But the one thin gI couldn't do was locate the file when it was retrieved later.  You see, the custom type doesn't have access to the instance at all, so it had no way of knowing the ID of the record.  When saving, it dynamically added an after-save handler which let it gain access to the ID, but when retrieving it later, didn't quite have the ability.</p>


<p>A hack was to make it so the custom type's load method would redefine the getter in the method to pass in the ID, but that only worked on the 2nd call to the object.  So you couldn't do this:</p>


<pre><code class="ruby">user = User[123]<br />user.avatar.url</code></pre>


<p>The redefinition was only in effect on the second call, so it was rather hacky.  Any changing so the custom type could get to the instance really muddies up the whole object model.</p>


<p>Additionally, as I was contemplating ways around it, I realized another negative of my method: it couldn't import a database from the ActiveRecord usage of Paperclip.  Sure, you can use ActiveRecord within Merb, but if someone wanted to move from ActiveRecord to DataMapper with an existing database, they wouldn't be able to.</p>


<p>So, in following with the Occam's razor / KISS ideology, I went back to simply update the original implementation and within 15 minutes, I had it working, completely with retrieving and all.  Granted, not all the work was wasted.  I still needed the rewritten validations, and was good to add to DataMapper (as I know I will use that later on).  Additionally, I now know how to develop custom types inside and out.</p>


<p>So now, the class definition looks more like:</p>


<pre><code class="ruby">class User<br />  include DataMapper::Resource<br />  include Paperclip::Resource<br /><br />  property :id, Fixnum, :serial =&gt; true<br />  property :username, String<br />  has_attached_file :avatar, <br />                    :styles =&gt; { :medium =&gt; &quot;300x300&gt;&quot;,<br />                                 :thumb =&gt; &quot;100x100&gt;&quot; }<br />end</code></pre>


<p>Even better, it should be compatible with existing databases that might want to migrate from ActiveRecord to DataMapper.</p>




</div>

<div class="meta group">
  <div class="signature">
    <p>Saturday, April 19, 2008</p>
  </div>	
  <div class="tags">
    &nbsp;
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'invalidlogic'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2008/04/18/first-open-source-contributions/" title="Previous post: First open source contributions">First open source contributions</a></div>
  
  
  
    <div class="next"><a class="next" href="/2008/04/22/history-blog-meme/" title="Next post: History Blog Meme">History Blog Meme</a> &rarr;</div>
  
</div>
    </div>

    <div id="sidebar">
      <h3>About</h3>
      <div class="textwidget">
        This is the personal blog of Ken Robertson.  I'm a developer at <a href="http://involver.com/">Involver</a> working in Ruby/Rails.  In a former life, I worked in .NET for many years and since moved on.<br/>
        <br/>
        Now, I get to make Rails scale, cook all day long with chef, and experiment with building highly concurrent systems.<br/>
        <br/>
        In my spare time, I like to build things.  I like to experiment with different technologies to find how they best fit onto my utility belt.<br/>
        <br/>
        I sometimes blog.  You'll find those things here.<br/>
        <br/>
        I sometimes code.  You'll find those on <a href="http://github.com/krobertson">Github</a>.<br/>
      </div>

      <h3>Search</h3>
      <form method="get" action="http://www.google.com/search">
        <div>
          <label class="screen-reader-text" for="s">Search for:</label>
          <input type="text" id="s" name="q" value="" />
          <input type="hidden" name="q" value="site:invalidlogic.com" />
          <input type="submit" id="searchsubmit" value="Search" />
        </div>
      </form>

      <h3>Recent Posts</h3>
      <ul>
        
          <li><a href="/2011/04/14/power-through-environments/">Power through environments</a></li>
        
          <li><a href="/2011/04/12/serving-static-content-via-post-from-nginx/">Serving Static Content Via POST From Nginx</a></li>
        
          <li><a href="/2011/02/16/our-pain-points-with-ec2/">Our pain points with EC2 and how our moved solved them</a></li>
        
          <li><a href="/2011/02/11/how-we-did-a-datacenter-migration-with-no-downtime/">How we did a datacenter migration with no downtime</a></li>
        
          <li><a href="/2011/02/07/how-a-deprecated-method-can-take-down-a-process/">How a deprecated method can take down a process</a></li>
        
    	</ul>
    </div>

  </div>

  <div id="footer">
    <p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a></p>
  </div>
</body>
</html>