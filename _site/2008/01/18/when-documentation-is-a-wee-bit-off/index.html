<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head profile="http://gmpg.org/xfn/11">
    <title>When documentation is a wee bit off &mdash; In Valid Logic</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Endlessly expanding technology" />
    <meta name="author" content="Ken Robertson" />
    <meta name="generator" content="jekyll" />

    <link href="/css/site.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/css/pygments/trac.css" rel="stylesheet" type="text/css" media="screen" />

    <link href="/atom.xml" rel="alternate" title="Ken Robertson's Atom Feed" type="application/atom+xml" />
    <link href="/rss.xml" rel="alternate" title="Ken Robertson's RSS Feed" type="application/rss+xml" />

    <link rel='index' title='In Valid Logic' href='http://invalidlogic.com/' />
  </head>

<body>
  <div id="container" class="group">

    <h1><a href="http://invalidlogic.com">In Valid Logic</a></h1>
    <div id="bubble"><p>Endlessly expanding technology</p></div>

    <div id="content" class="group">
      <h2>When documentation is a wee bit off</h2>

<div class="main">
  <p>Humans are never perfect, and since humans write documentation, it isn't always 100% accurate.</p>




<p>Take the documentation on MSDN regarding <a href="http://msdn2.microsoft.com/en-us/library/0ka9477y.aspx">Managed Thread Pools</a>, in the "Maximum Number of Thread Pool Threads" section (emphasis mine):</p>




<p><blockquote>The number of operations that can be queued to the thread pool is limited only by available memory; however, the thread pool limits the number of threads that can be active in the process simultaneously. By default, the limit is <b>25 worker threads per CPU</b> and 1,000 I/O completion thread.</blockquote></p>




<p>25 threads per CPU?  Not bad, pretty good.  Except it is a little bit off.  In fact, it is missing a 0.  Yes, it isn't 25 threads per CPU, it is 250 threads per CPU.  An error of 10 fold.</p>




<p>This has reared its head a few times with the Community Server add-on Mail Gateway.  It makes use of the thread pool to process email messages as they come in and send them to the CS site.  One problem was that when there is a backlog of messages, it can hammer the site quite a bit.  If you have some issues connecting to the mail server, or configuration issues, etc, and messages build up in the mailbox (ie, couple thousand, or some clients 50k+ messages), then when things get resolved, it tries to process the whole back log, but ends up hitting the site so hard it will fail processing messages and continue to retry them, making it work through the messages very slowly.</p>




<p>When Mail Gateway was written, I had read about the "25 threads per CPU" and figured CS could surely handle a maxed out thread pool no problem... essentially 25 users on a site?  That's not bad.  And if they had a dual CPU machine, thats 50... that's maybe pushing it, but still should work ok.</p>




<p>However, we first starting using the managed thread pool like 2 years ago.  Since then, we've seen a major change with multi-core machines.</p>




<p>So now, look at the issue of hammer a site with Mail Gateway.  250 threads?  All hammering on a site?  Ohh yeah, I could see that one causing a problem.  But what if the client has a multi-core machine?  Say it is a dual quad-core CPU box... you're looking at 8 CPUs as far as it is concerned.  You're talking 2,000 threads.  Think 2,000 messages being submitted concurrently to a site would bring it to its knees?  Yeah, I think so.</p>




<p>The 25 vs 250 thing is pretty big, especially when you take into account the "per CPU" bit.</p>




<p>So the solution?  Override the number of threads available by specifying it in the application on start up using <a href="http://msdn2.microsoft.com/en-us/library/system.threading.threadpool.setmaxthreads.aspx">ThreadPool.SetMaxThreads()</a>.  This way, we can also avoid the scaling per CPU issue as well... we don't want to send more messages because there is another CPU, we want a fixed number.  .NET 1.1 (when we originally wrote the code) didn't have a method available to set the number of threads, but with .NET 2.0, we now can.  Expect an updated build of the Mail Gateway service soon with the change.  It will now default to only 15 threads, but can be configurable in the mailgateway.config file.</p>




</div>

<div class="meta group">
  <div class="signature">
    <p>Friday, January 18, 2008</p>
  </div>	
  <div class="tags">
    &nbsp;
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'invalidlogic'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2008/01/15/the-problem-with-online-movie-rentals/" title="Previous post: The problem with online movie rentals">The problem with online movie rentals</a></div>
  
  
  
    <div class="next"><a class="next" href="/2008/01/25/is-this-book-serious/" title="Next post: Is this book serious?">Is this book serious?</a> &rarr;</div>
  
</div>
    </div>

    <div id="sidebar">
      <h3>About</h3>
      <div class="textwidget">
        This is the personal blog of Ken Robertson.  I'm a developer at <a href="http://involver.com/">Involver</a> working in Ruby/Rails.  In a former life, I worked in .NET for many years and since moved on.<br/>
        <br/>
        Now, I get to make Rails scale, cook all day long with chef, and experiment with building highly concurrent systems.<br/>
        <br/>
        In my spare time, I like to build things.  I like to experiment with different technologies to find how they best fit onto my utility belt.<br/>
        <br/>
        I sometimes blog.  You'll find those things here.<br/>
        <br/>
        I sometimes code.  You'll find those on <a href="http://github.com/krobertson">Github</a>.<br/>
      </div>

      <h3>Search</h3>
      <form method="get" action="http://www.google.com/search">
        <div>
          <label class="screen-reader-text" for="s">Search for:</label>
          <input type="text" id="s" name="q" value="" />
          <input type="hidden" name="q" value="site:invalidlogic.com" />
          <input type="submit" id="searchsubmit" value="Search" />
        </div>
      </form>

      <h3>Recent Posts</h3>
      <ul>
        
          <li><a href="/2011/02/07/how-a-deprecated-method-can-take-down-a-process/">How a deprecated method can take down a process</a></li>
        
          <li><a href="/2011/01/19/love-your-dependency-management/">Love your dependency management</a></li>
        
          <li><a href="/2010/12/08/progress-through-iterating/">Progress through iterating</a></li>
        
          <li><a href="/2010/10/25/tool-enlightenment-part-2/">Tool Enlightenment, Part 2</a></li>
        
          <li><a href="/2010/10/14/tool-enlightenment/">Tool Enlightenment</a></li>
        
    	</ul>
    </div>

  </div>

  <div id="footer">
    <p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a></p>
  </div>
</body>
</html>